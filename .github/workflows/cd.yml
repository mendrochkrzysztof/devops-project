name: CD Pipeline

on:
  workflow_dispatch:  # Manual trigger
  push:
    tags:
      - 'v*.*.*'

env:
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  DEPLOY_DIR: /opt/devops-project

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.1
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Configure SSH known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
        
    - name: Copy deployment files
      run: |
        rsync -avz \
          --exclude '.git' \
          --exclude '.github' \
          --exclude 'node_modules' \
          ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$DEPLOY_DIR/
          
    - name: Deploy application
      run: |
        ssh -o StrictHostKeyChecking=no \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
          "cd $DEPLOY_DIR && \
           docker-compose pull && \
           docker-compose down && \
           docker-compose up -d --build && \
           docker system prune -af"
           
    - name: Verify deployment
      run: |
        sleep 30
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
          "curl -f http://localhost:8080/api/health || exit 1"
          
    - name: Send deployment notification
      if: success()
      run: |
        echo "Deployment completed successfully!"
        # Add notification logic here (Slack, Email, etc.)